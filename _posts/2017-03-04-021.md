---
layout: post
title: DUB を使った D 言語開発 tips
comments: true
---

## DUB とは

D 言語のためのパッケージ管理ツールです。
あまり詳しくないですが、多分 Clojure の `lein` や Scala の `sbt` に近いです。
基本的な使い方は、このページによくまとまっています

[D言語でビルドツールDUBを用いて便利なライブラリをより簡単に利用する](http://qiita.com/yasei_no_otoko/items/2724eebab10f5cd0a02f)

本稿では、そこに書いてない便利な使い方をまとめていきます。

## ローカルにあるパッケージの利用

ローカルに用意した dub パッケージを追加するときは、`dub.json`にバージョンではなくパスを書きます。

``` yaml
"dependencies": {
    "mir": { "path": "./mir" },
    "ggplotd": ">=0.4.5",
    ...
}
```

これで、再帰的にきちんと依存解決してくれます、便利。
きちんとローカルのパッケージもバージョン管理をするためには、git submodule などを利用すると良いと思います。

[fork して自前パッチを当てたmirパッケージを使用したd-svmパッケージの例](https://github.com/ShigekiKarita/d-svm/tree/410f45281fbc1eb3eaebc7f7845b5c5fc5eb0812)

## 単体テストの実行

D 言語には言語機能として、単体テスト(unittest)やカバレッジ計測がサポートされています。

``` D
import mir.ndslice;

auto diag(S)(S s, long k=0) {
  auto sk = k >= 0 ?  s[0 .. $, k .. $] : s[-k .. $, 0 .. $];
  return sk.diagonal;
}

unittest {
  //  -------
  // | 0 1 2 |
  // | 3 4 5 |
  //  -------
  auto a = iota(2, 3).canonical;
  assert(a.diag == [0, 4]);
  assert(a.diag(1) == [1, 5]);
  assert(a.diag(-1) == [3]);
}
```

`dub test`や`dub test -b unittest-cov`でテストの実行やカバレッジ計測(結果は`*.lst`ファイルに出力)できます。
これだけでは、まだ`dmd`コマンドと変わらないように思いますが、次節でもっと便利な使い方を紹介します。

## 外部ツールとの連携

BitbucketやGitHubリポジトリのREADMEによく、このようなバッジ

[![Build Status](https://travis-ci.org/ShigekiKarita/numir.svg?branch=master)](https://travis-ci.org/ShigekiKarita/numir)
[![Coverage Status](https://coveralls.io/repos/github/ShigekiKarita/numir/badge.svg?branch=master)](https://coveralls.io/github/ShigekiKarita/numir?branch=master)

を見かけると思います。具体的にはTravisという自動で環境構築からテストまで行うCIと、
テストのカバレッジを見やすくしてくれる Coveralls というサービスをよく見かけます。

### Travis CI, Coveralls 連携

[Travis CI](https://travis-ci.org/), [Coveralls](https://coveralls.io/)
にGitHubなどのアカウントでログインして既存のリポジトリを追加できます。
あまり知られていませんが、TravisではLinuxだけでなくOSXも動きます。
Coverallsとの連携には doveralls というツールがおすすめです。
次のような`.travis.yml`ファイルをGitリポジトリの配下におくといい感じにやってくれます。


``` yaml
os:
  - linux
  - osx

language: d

d:
  - ldc-1.1.0
  - dmd

install:
  - dub fetch doveralls

script:
  - dub test -b unittest-cov
　- dub run doveralls
```

もし、プライベートであったり、GPGPUなどTravisでは実行できないようなライブラリを作っている場合は、
ローカルでテストを実行して、カバレッジ計測だけCoverallsを利用したいということがあると思います。
その場合は、ローカルで次のような操作をすると良いでしょう。

``` sh
$ dub fetch doveralls
$ dub test -b unittest-cov
$ dub run doveralls -- -t <coverallsのrepo_token>
```

### dub レポジトリの登録

## ドキュメントの生成
