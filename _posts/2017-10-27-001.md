---
author: karita
layout: post
title: MirのndsliceでMKLを使う
tags: d
comments: true
---

前回はMirについての入門記事を書きました。
いつのまにか mir-algorithm のREADMEに件の記事が載っていてビックリしました。

今回は、前回mir-glasの不具合で断念した、行列演算をIntel MKLで実現しようと思います。


## Intel MKLのインストール

Anacondaを使うのが一番簡単だと思います。`conda install mkl` とかで一瞬です。
デフォルトだと`~/anaconda3/lib/libmkl_rt.so`とかにできているので

``` console
$ cd ~/anaconda3/lib
$ ln -s libmkl_rt.so libblas.so
$ ln -s libmkl_rt.so libcblas.so
$ ln -s libmkl_rt.so liblapack.so
```

としてmir-blasやmir-lapackが使うライブラリ名にして、`LIBRARY_PATH`, `LD_LIBRARY_PATH`を通しておきます。

## Lubeck

Mir-BLAS/LAPACKはLubeckというmirのndslice用にラップしたライブラリから使うと便利です。
コードは前回のmir-introリポジトリをそのまま使った別ブランチに用意しました。

https://github.com/ShigekiKarita/mir-intro/tree/lubeck

使い方は a と b の ndslice の行列積を c に格納するには、`c[] = mtimes(a, b);`という感じで計算します。

こちらが、実行結果です。

![mkl.png]({{ site.baseurl }}/assets/mkl.svg)

衝撃的ですね...。これからはMKLをメインに使いたいと思います。

ところで、最近はCUDA関係のライブラリをDから使うためのライブラリを作っています。早速cuBLAS(NVIDIAのBLASライブラリ)が動くようになったので、次回はこの辺のベンチマークをとってみたいですね。


